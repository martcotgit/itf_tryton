{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Catalogue de palettes | Ilnu Transforme" }}{% endblock %}

{% block extra_head %}
<meta name="description" content="{{ page_description }}">
<meta name="keywords" content="{{ page_keywords }}">
<meta name="robots" content="index, follow">
<link rel="canonical" href="{{ canonical_url }}">
<meta property="og:type" content="website">
<meta property="og:title" content="{{ page_title|default:'Catalogue de palettes ‚Äì Ilnu Transforme' }}">
<meta property="og:description" content="{{ page_description }}">
<meta property="og:url" content="{{ canonical_url }}">
<meta property="og:locale" content="fr_CA">
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="{{ page_title|default:'Catalogue de palettes ‚Äì Ilnu Transforme' }}">
<meta property="twitter:description" content="{{ page_description }}">
{% if products_schema %}
<script type="application/ld+json">{{ products_schema|safe }}</script>
{% endif %}
{% endblock %}

{% block content %}
<main class="products-main" role="main">
    <!-- Sticky Header Bar -->
    <div class="page-header-bar">
        <div class="page-header-container">
            <div class="page-header-left">
                <nav class="breadcrumb" aria-label="Breadcrumb">
                    <a href="{% url 'core:home' %}">Accueil</a>
                    <span class="separator">/</span>
                    {% if view_mode == 'categories' %}
                    <span class="current">Produits</span>
                    {% else %}
                    <a href="{% url 'core:products' %}">Produits</a>
                    <span class="separator">/</span>
                    <span class="current">{{ current_category.name|default:"Cat√©gorie" }}</span>
                    {% endif %}
                </nav>
                <h1>
                    {% if view_mode == 'categories' %}
                    Nos Produits
                    {% else %}
                    {{ current_category.name|default:"Produits" }}
                    {% endif %}
                </h1>
            </div>

            <div class="page-header-right">
                {% if view_mode == 'products' %}
                <a href="{% url 'core:products' %}" class="btn btn-ghost btn-sm">
                    ‚Üê Toutes les cat√©gories
                </a>
                {% elif view_mode == 'categories' %}
                <a href="{% url 'core:contact' %}" class="btn btn-secondary btn-sm">
                    Obtenir mon devis
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="product-container">
        {% if view_mode == 'categories' %}
        <!-- Category Grid View -->
        {% if categories %}

        <ul class="category-grid" role="list">
            {% for category in categories %}
            <li role="listitem">
                <a href="{% url 'core:products_by_category' category.category_id %}" class="category-card">
                    <div class="category-card__image-wrapper">
                        <div class="category-card__image" {% if category.image_data_uri %}
                            style="background-image: url('{{ category.image_data_uri }}');" {% else %}
                            style="background: linear-gradient(135deg, var(--brand-primary) 0%, var(--secondary-color) 100%);"
                            {% endif %}>
                        </div>
                        <div class="category-card__overlay"></div>
                    </div>
                    <div class="category-card__content">
                        <h3 class="category-card__title">{{ category.name }}</h3>
                        <span class="category-card__count">{{ category.product_count }}
                            palette{{category.product_count|pluralize }}</span>
                    </div>
                </a>
            </li>
            {% endfor %}
        </ul>

        <!-- Global CTA Banner -->
        <section class="catalog-cta-banner">
            <div class="catalog-cta-banner__content">
                <span class="catalog-cta-banner__icon">üí¨</span>
                <p>Volume important ou besoin sp√©cifique ? <strong>Obtenez un devis sur mesure en 24h.</strong></p>
            </div>
            <a href="{% url 'core:contact' %}" class="btn btn-primary">Obtenir mon devis</a>
        </section>

        {% else %}
        <!-- Empty State for Categories -->
        <div class="empty-state">
            <svg class="empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="1.5">
                <path d="M20 7L12 3L4 7M20 7L12 11M20 7V17L12 21M12 11L4 7M12 11V21M4 7V17L12 21" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
            <h3>Notre catalogue arrive bient√¥t</h3>
            <p>Nous mettons √† jour nos produits. Contactez-nous pour conna√Ætre nos disponibilit√©s actuelles.</p>
            <a href="{% url 'core:contact' %}" class="btn btn-primary">Nous contacter</a>
        </div>
        {% endif %}

        {% else %}
        <!-- Product List View (Filtered by Category) -->
        {% if products %}
        <div class="category-intro">
            <p class="lead">{{ products_total }} produit{{ products_total|pluralize }} disponible{{
                products_total|pluralize }} dans cette cat√©gorie.</p>
        </div>

        <ul class="product-grid" role="list">
            {% for product in products %}
            <li class="product-card-compact" role="listitem">
                <!-- Image Zone -->
                <div class="product-card-image">
                    {% if product.image_url %}
                    <img src="{{ product.image_url }}" alt="{{ product.name }}" loading="lazy">
                    {% else %}
                    <img src="{% static " img/palette-bois.jpg" %}" alt="{{ product.name }}" loading="lazy"
                        class="product-placeholder-image">
                    {% endif %}
                </div>

                <div class="product-card-header">
                    <span class="product-sku">{{ product.code|default:"SKU" }}</span>
                </div>

                <div class="product-card-body">
                    <h3 class="product-title">{{ product.name }}</h3>
                    <p class="product-dimensions">{{ product.display_description|linebreaksbr }}</p>
                </div>

                <div class="product-card-footer product-card-footer--display">
                    <span class="product-price">Sur devis</span>
                    {% if product.quantity_available and product.quantity_available > 0 %}
                    <span class="product-stock in-stock">
                        <svg class="stock-icon" viewBox="0 0 12 12">
                            <circle cx="6" cy="6" r="4" fill="currentColor" />
                        </svg>
                        En stock
                    </span>
                    {% else %}
                    <span class="product-stock out-of-stock">Sur commande</span>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>

        {% if paginator.num_pages > 1 %}
        <nav class="product-pagination" aria-label="Pagination des produits"
            style="margin-top: 2rem; display: flex; justify-content: center;">
            <div class="product-pagination__controls">
                {% if products.has_previous %}
                <a class="btn btn-ghost btn-sm" href="?page={{ products.previous_page_number }}" rel="prev">‚Üê
                    Pr√©c√©dent</a>
                {% endif %}

                <span style="margin: 0 1rem; align-self: center;">Page {{ products.number }} sur {{
                    products.paginator.num_pages }}</span>

                {% if products.has_next %}
                <a class="btn btn-ghost btn-sm" href="?page={{ products.next_page_number }}" rel="next">Suivant ‚Üí</a>
                {% endif %}
            </div>
        </nav>
        {% endif %}

        <!-- Global CTA Banner -->
        <section class="catalog-cta-banner">
            <div class="catalog-cta-banner__content">
                <span class="catalog-cta-banner__icon">üí¨</span>
                <p>Vous avez des questions ou besoin d'un volume important ? <strong>Contactez-nous pour un devis
                        personnalis√©.</strong></p>
            </div>
            <a href="{% url 'core:contact' %}" class="btn btn-primary">Demander un devis ‚Üí</a>
        </section>

        {% else %}
        <!-- Empty State for Products -->
        <div class="empty-state">
            <svg class="empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="1.5">
                <path d="M20 12V22H4V12" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M22 7H2V12H22V7Z" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 22V7" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <h3>Aucun produit dans cette cat√©gorie</h3>
            <p>Cette cat√©gorie ne contient actuellement aucun produit disponible.</p>
            <a href="{% url 'core:products' %}" class="btn btn-primary">‚Üê Voir toutes les cat√©gories</a>
        </div>
        {% endif %}
        {% endif %}
    </div>
</main>
{% endblock %}