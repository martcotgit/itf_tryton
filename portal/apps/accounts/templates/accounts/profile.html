{% extends "base.html" %}
{% load static %}

{% block title %}Espace client ITF ‚Äì Profil{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/intl-tel-input/css/intlTelInput.min.css' %}">
{% endblock %}

{% block content %}
<main id="contenu-principal" class="main profile-main" role="main">
    <section class="profile-section">
        <div class="container profile-container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb-nav" aria-label="Fil d'Ariane">
                <a href="{% url 'core:home' %}">Accueil</a>
                <span aria-hidden="true">/</span>
                <span aria-current="page">Profil client</span>
            </nav>

            <!-- Compact Hero -->
            <header class="profile-hero-compact">
                <h1>
                    Profil
                    <span class="hero-meta">{{ user.email }}</span>
                </h1>
            </header>

            <!-- Unified Card Layout -->
            <article class="profile-unified-card">

                <!-- Section Profil (Informations g√©n√©rales) -->
                <section class="profile-section-block">
                    <header class="section-header">
                        <h2>
                            <span class="section-eyebrow">Coordonn√©es</span>
                            Informations g√©n√©rales
                        </h2>
                    </header>

                    <form method="post" novalidate class="profile-form profile-form--flat">
                        {% csrf_token %}
                        <input type="hidden" name="form_name" value="profile">

                        {% if profile_form.non_field_errors %}
                        <div class="form-errors" role="alert">
                            {% for error in profile_form.non_field_errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="{{ profile_form.company_name.id_for_label }}">
                                Nom de l'entreprise <span class="label-optional">(optionnel)</span>
                            </label>
                            {{ profile_form.company_name }}
                            {% if profile_form.company_name.errors %}
                            <div class="field-error" role="alert">
                                {% for error in profile_form.company_name.errors %}
                                <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <span class="field-hint">Affich√© sur les factures et soumissions.</span>
                        </div>

                        <div class="form-row two-columns">
                            <div class="form-group">
                                <label for="{{ profile_form.first_name.id_for_label }}">Pr√©nom <span
                                        class="required-mark">*</span></label>
                                {{ profile_form.first_name }}
                                {% if profile_form.first_name.errors %}
                                <div class="field-error" role="alert">
                                    {% for error in profile_form.first_name.errors %}
                                    <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ profile_form.last_name.id_for_label }}">Nom <span
                                        class="required-mark">*</span></label>
                                {{ profile_form.last_name }}
                                {% if profile_form.last_name.errors %}
                                <div class="field-error" role="alert">
                                    {% for error in profile_form.last_name.errors %}
                                    <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-row two-columns">
                            <div class="form-group">
                                <label for="{{ profile_form.email.id_for_label }}">Courriel</label>
                                {{ profile_form.email }}
                            </div>
                            <div class="form-group phone-field-group"
                                data-phone-utils-url="{% static 'vendor/intl-tel-input/js/utils.js' %}">
                                <label for="{{ profile_form.phone.id_for_label }}">T√©l√©phone</label>
                                {{ profile_form.phone }}
                                {% if profile_form.phone.errors %}
                                <div class="field-error" role="alert">
                                    {% for error in profile_form.phone.errors %}
                                    <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div id="phone-client-error" class="field-error is-hidden" role="alert"
                                    aria-live="polite"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="{{ profile_form.address.id_for_label }}">Adresse compl√®te</label>
                            {{ profile_form.address }}
                            {% if profile_form.address.errors %}
                            <div class="field-error" role="alert">
                                {% for error in profile_form.address.errors %}
                                <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-row two-columns">
                            <div class="form-group">
                                <label for="{{ profile_form.city.id_for_label }}">Ville</label>
                                {{ profile_form.city }}
                                {% if profile_form.city.errors %}
                                <div class="field-error" role="alert">
                                    {% for error in profile_form.city.errors %}
                                    <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ profile_form.postal_code.id_for_label }}">Code postal</label>
                                {{ profile_form.postal_code }}
                                {% if profile_form.postal_code.errors %}
                                <div class="field-error" role="alert">
                                    {% for error in profile_form.postal_code.errors %}
                                    <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Enregistrer</button>
                            <span class="form-hint">Mise √† jour imm√©diate.</span>
                        </div>
                    </form>
                </section>

                <!-- Section S√©curit√© (Mot de passe) -->
                <section class="profile-section-block profile-section-block--security">
                    <header class="section-header">
                        <h2>
                            <span class="section-eyebrow">S√©curit√©</span>
                            <span>Mot de passe <i class="lock-icon" aria-hidden="true">üîí</i></span>
                        </h2>
                    </header>

                    <form method="post" novalidate class="profile-form profile-form--flat">
                        {% csrf_token %}
                        <input type="hidden" name="form_name" value="password">

                        {% if password_form.non_field_errors %}
                        <div class="form-errors" role="alert">
                            {% for error in password_form.non_field_errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="{{ password_form.current_password.id_for_label }}">Mot de passe actuel</label>
                            {{ password_form.current_password }}
                            {% if password_form.current_password.errors %}
                            <div class="field-error" role="alert">
                                {% for error in password_form.current_password.errors %}
                                <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-row two-columns">
                            <div class="form-group">
                                <label for="{{ password_form.new_password1.id_for_label }}">Nouveau mot de passe</label>
                                {{ password_form.new_password1 }}
                                <span class="field-hint">{{ password_form.new_password1.help_text }}</span>
                                {% if password_form.new_password1.errors %}
                                <div class="field-error" role="alert">
                                    {% for error in password_form.new_password1.errors %}
                                    <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ password_form.new_password2.id_for_label }}">Confirmer</label>
                                {{ password_form.new_password2 }}
                                {% if password_form.new_password2.errors %}
                                <div class="field-error" role="alert">
                                    {% for error in password_form.new_password2.errors %}
                                    <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-secondary">Mettre √† jour</button>
                        </div>
                    </form>
                </section>

            </article>

            <!-- Discrete Help Link -->
            <div class="help-banner-discrete">
                <span class="help-text">Besoin d'aide avec votre compte ?</span>
                <a href="mailto:info@paletteitf.ca" class="help-link">Contactez notre support ‚Üí</a>
            </div>

        </div>
    </section>
</main>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="{% static 'vendor/intl-tel-input/js/intlTelInput.min.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const phoneInput = document.getElementById('id_phone');
        if (!phoneInput || !window.intlTelInput) {
            return;
        }
        const phoneGroup = document.querySelector('.phone-field-group');
        const utilsScriptUrl = phoneGroup ? phoneGroup.dataset.phoneUtilsUrl : undefined;
        const errorContainer = document.getElementById('phone-client-error');
        const form = phoneInput.form;

        const iti = window.intlTelInput(phoneInput, {
            initialCountry: 'ca',
            preferredCountries: ['ca', 'us'],
            autoPlaceholder: 'polite',
            nationalMode: false,
            formatOnDisplay: true,
            utilsScript: utilsScriptUrl,
        });

        const errorMessages = {
            0: "Num√©ro de t√©l√©phone invalide.",
            1: "L‚Äôindicatif du pays est invalide.",
            2: "Le num√©ro est trop court pour ce pays.",
            3: "Le num√©ro est trop long pour ce pays.",
            4: "Num√©ro de t√©l√©phone invalide.",
        };

        function showError(message) {
            if (!errorContainer) {
                return;
            }
            errorContainer.textContent = message;
            errorContainer.classList.remove('is-hidden');
        }

        function clearError() {
            if (!errorContainer) {
                return;
            }
            errorContainer.textContent = "";
            errorContainer.classList.add('is-hidden');
        }

        function validateNumber() {
            const value = phoneInput.value.trim();
            if (value === "") {
                clearError();
                return true;
            }
            if (typeof iti.isValidNumber !== "function") {
                return true;
            }
            if (iti.isValidNumber()) {
                clearError();
                return true;
            }
            const code = iti.getValidationError();
            showError(errorMessages[code] || "Num√©ro de t√©l√©phone invalide.");
            return false;
        }

        function normalizeNumber() {
            if (!phoneInput.value.trim()) {
                return;
            }
            try {
                if (window.intlTelInputUtils) {
                    phoneInput.value = iti.getNumber(window.intlTelInputUtils.numberFormat.E164);
                } else {
                    phoneInput.value = iti.getNumber();
                }
            } catch (error) {
                console.warn("Normalisation du num√©ro impossible", error);
            }
        }

        function attachHandlers() {
            phoneInput.addEventListener('input', validateNumber);
            phoneInput.addEventListener('blur', () => {
                if (validateNumber()) {
                    normalizeNumber();
                }
            });
            if (form) {
                form.addEventListener('submit', (event) => {
                    const submitBtn = form.querySelector('button[type="submit"]');

                    // Si c'est le formulaire "profile", on valide le t√©l√©phone
                    if (form.querySelector('input[name="form_name"]').value === 'profile') {
                        if (!validateNumber()) {
                            event.preventDefault();
                            phoneInput.focus();
                            return;
                        }
                        normalizeNumber();
                    }
                });
            }
        }

        if (iti.promise) {
            iti.promise.then(attachHandlers);
        } else {
            attachHandlers();
        }
    });
</script>
{% endblock %}