{% extends "base.html" %}
{% load static %}

{% block title %}Espace client ITF – Profil{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'vendor/intl-tel-input/css/intlTelInput.min.css' %}">
{% endblock %}

{% block content %}
<main id="contenu-principal" class="main profile-main" role="main">
    <section class="profile-section">
        <div class="container profile-container">
            <header class="profile-header">
                <h1>Profil client</h1>
                <p>Actualisez vos coordonnées et mettez à jour votre mot de passe afin de garder votre compte sécurisé.</p>
            </header>
            <div class="profile-grid">
                <article class="profile-card">
                    <h2>Informations générales</h2>
                    <form method="post" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="form_name" value="profile">
                        {% if profile_form.non_field_errors %}
                            <div class="form-errors" role="alert">
                                {% for error in profile_form.non_field_errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ profile_form.company_name.id_for_label }}">{{ profile_form.company_name.label }}</label>
                                {{ profile_form.company_name }}
                                {% if profile_form.company_name.errors %}
                                    <div class="field-error" role="alert">
                                        {% for error in profile_form.company_name.errors %}<p>{{ error }}</p>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-row two-columns">
                            <div class="form-group">
                                <label for="{{ profile_form.first_name.id_for_label }}">{{ profile_form.first_name.label }}</label>
                                {{ profile_form.first_name }}
                                {% if profile_form.first_name.errors %}
                                    <div class="field-error" role="alert">
                                        {% for error in profile_form.first_name.errors %}<p>{{ error }}</p>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ profile_form.last_name.id_for_label }}">{{ profile_form.last_name.label }}</label>
                                {{ profile_form.last_name }}
                                {% if profile_form.last_name.errors %}
                                    <div class="field-error" role="alert">
                                        {% for error in profile_form.last_name.errors %}<p>{{ error }}</p>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ profile_form.email.id_for_label }}">{{ profile_form.email.label }}</label>
                                {{ profile_form.email }}
                            </div>
                            <div class="form-group phone-field-group" data-phone-utils-url="{% static 'vendor/intl-tel-input/js/utils.js' %}">
                                <label for="{{ profile_form.phone.id_for_label }}">{{ profile_form.phone.label }}</label>
                                {{ profile_form.phone }}
                                {% if profile_form.phone.errors %}
                                    <div class="field-error" role="alert">
                                        {% for error in profile_form.phone.errors %}<p>{{ error }}</p>{% endfor %}
                                    </div>
                                {% endif %}
                                <div id="phone-client-error" class="field-error is-hidden" role="alert" aria-live="polite"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ profile_form.address.id_for_label }}">{{ profile_form.address.label }}</label>
                                {{ profile_form.address }}
                                {% if profile_form.address.errors %}
                                    <div class="field-error" role="alert">
                                        {% for error in profile_form.address.errors %}<p>{{ error }}</p>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-row two-columns">
                            <div class="form-group">
                                <label for="{{ profile_form.city.id_for_label }}">{{ profile_form.city.label }}</label>
                                {{ profile_form.city }}
                                {% if profile_form.city.errors %}
                                    <div class="field-error" role="alert">
                                        {% for error in profile_form.city.errors %}<p>{{ error }}</p>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ profile_form.postal_code.id_for_label }}">{{ profile_form.postal_code.label }}</label>
                                {{ profile_form.postal_code }}
                                {% if profile_form.postal_code.errors %}
                                    <div class="field-error" role="alert">
                                        {% for error in profile_form.postal_code.errors %}<p>{{ error }}</p>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Enregistrer les changements</button>
                    </form>
                </article>
                <article class="profile-card">
                    <h2>Mot de passe</h2>
                    <form method="post" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="form_name" value="password">
                        {% if password_form.non_field_errors %}
                            <div class="form-errors" role="alert">
                                {% for error in password_form.non_field_errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-group">
                            <label for="{{ password_form.current_password.id_for_label }}">{{ password_form.current_password.label }}</label>
                            {{ password_form.current_password }}
                            {% if password_form.current_password.errors %}
                                <div class="field-error" role="alert">
                                    {% for error in password_form.current_password.errors %}<p>{{ error }}</p>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ password_form.new_password1.id_for_label }}">{{ password_form.new_password1.label }}</label>
                            {{ password_form.new_password1 }}
                            <small class="form-help">{{ password_form.new_password1.help_text }}</small>
                            {% if password_form.new_password1.errors %}
                                <div class="field-error" role="alert">
                                    {% for error in password_form.new_password1.errors %}<p>{{ error }}</p>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ password_form.new_password2.id_for_label }}">{{ password_form.new_password2.label }}</label>
                            {{ password_form.new_password2 }}
                            {% if password_form.new_password2.errors %}
                                <div class="field-error" role="alert">
                                    {% for error in password_form.new_password2.errors %}<p>{{ error }}</p>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-secondary">Mettre à jour le mot de passe</button>
                    </form>
                </article>
            </div>
        </div>
    </section>
</main>
{% endblock %}

{% block extra_scripts %}
    {{ block.super }}
    <script src="{% static 'vendor/intl-tel-input/js/intlTelInput.min.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const phoneInput = document.getElementById('id_phone');
            if (!phoneInput || !window.intlTelInput) {
                return;
            }
            const phoneGroup = document.querySelector('.phone-field-group');
            const utilsScriptUrl = phoneGroup ? phoneGroup.dataset.phoneUtilsUrl : undefined;
            const errorContainer = document.getElementById('phone-client-error');
            const form = phoneInput.form;

            const iti = window.intlTelInput(phoneInput, {
                initialCountry: 'ca',
                preferredCountries: ['ca', 'us'],
                autoPlaceholder: 'polite',
                nationalMode: false,
                formatOnDisplay: true,
                utilsScript: utilsScriptUrl,
            });

            const errorMessages = {
                0: "Numéro de téléphone invalide.",
                1: "L’indicatif du pays est invalide.",
                2: "Le numéro est trop court pour ce pays.",
                3: "Le numéro est trop long pour ce pays.",
                4: "Numéro de téléphone invalide.",
            };

            function showError(message) {
                if (!errorContainer) {
                    return;
                }
                errorContainer.textContent = message;
                errorContainer.classList.remove('is-hidden');
            }

            function clearError() {
                if (!errorContainer) {
                    return;
                }
                errorContainer.textContent = "";
                errorContainer.classList.add('is-hidden');
            }

            function validateNumber() {
                const value = phoneInput.value.trim();
                if (value === "") {
                    clearError();
                    return true;
                }
                if (typeof iti.isValidNumber !== "function") {
                    return true;
                }
                if (iti.isValidNumber()) {
                    clearError();
                    return true;
                }
                const code = iti.getValidationError();
                showError(errorMessages[code] || "Numéro de téléphone invalide.");
                return false;
            }

            function normalizeNumber() {
                if (!phoneInput.value.trim()) {
                    return;
                }
                try {
                    if (window.intlTelInputUtils) {
                        phoneInput.value = iti.getNumber(window.intlTelInputUtils.numberFormat.E164);
                    } else {
                        phoneInput.value = iti.getNumber();
                    }
                } catch (error) {
                    console.warn("Normalisation du numéro impossible", error);
                }
            }

            function attachHandlers() {
                phoneInput.addEventListener('input', validateNumber);
                phoneInput.addEventListener('blur', () => {
                    if (validateNumber()) {
                        normalizeNumber();
                    }
                });
                if (form) {
                    form.addEventListener('submit', (event) => {
                        if (!validateNumber()) {
                            event.preventDefault();
                            phoneInput.focus();
                            return;
                        }
                        normalizeNumber();
                    });
                }
            }

            if (iti.promise) {
                iti.promise.then(attachHandlers);
            } else {
                attachHandlers();
            }
        });
    </script>
{% endblock %}
